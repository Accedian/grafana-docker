machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.0-circleci'
    - sudo chmod 0755 /usr/bin/docker
  python:
    version: 2.7.3
  services:
    - docker
  environment:

dependencies:
  cache_directories:
    - "~/docker"

  pre:
    - docker info
    - echo $GRAFANA_VERSION
    - >
      if [ "$GRAFANA_VERSION" != "" ]; then
        echo "Building version ${GRAFANA_VERSION}"
        docker build \
          --build-arg DOWNLOAD_URL=https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_${GRAFANA_VERSION}_amd64.deb \
          --tag "grafana/grafana:${GRAFANA_VERSION}" \
          --no-cache=true .
        docker tag grafana/grafana:${GRAFANA_VERSION} grafana/grafana:latest

      else
        echo "Building latest for master"
        docker build \
          --build-arg DOWNLOAD_URL=https://s3-us-west-2.amazonaws.com/grafana-releases/master/grafana_latest_amd64.deb \
          --tag "grafana/grafana:master" \
          --no-cache=true .
      fi

test:
  override:
     - echo "test"

deployment:
  develop:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - >
        if [ "$GRAFANA_VERSION" != "" ]; then
          echo "push! ${GRAFANA_VERSION}"
          
        else
          echo "pushing! master"
          docker push grafana/grafana:master
        fi


#docker push grafana/grafana:${GRAFANA_TAG}
#docker push grafana/grafana:latest
#docker build --build-arg DOWNLOAD_URL=https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_${GRAFANA_VERSION}_amd64.deb --tag "grafana/grafana:${GRAFANA_TAG}" --no-cache=true .